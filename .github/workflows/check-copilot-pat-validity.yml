name: Copilotã‚¢ã‚µã‚¤ãƒ³ç”¨PATæœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # æ¯æ—¥ 9:00 JST (0:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-pat:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing issue
        id: existing_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã® Open ãª Issue ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          EXISTING_ISSUE=$(gh issue list \
            --repo "${GITHUB_REPOSITORY}" \
            --state open \
            --search "COPILOT_ASSIGN_PAT ã®æ›´æ–°ãŒå¿…è¦ã§ã™ in:title" \
            --json number \
            --jq '.[0].number // empty')
          
          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Existing issue found: #$EXISTING_ISSUE"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
          else
            echo "No existing issue found"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PAT validity
        id: check
        if: steps.existing_issue.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_ASSIGN_PAT }}
        run: |
          echo "Checking PAT validity..."
          
          # PAT ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "${GH_TOKEN}" ]; then
            echo "PAT is not set"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "error_message=COPILOT_ASSIGN_PAT ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # GitHub API ã‚’å‘¼ã³å‡ºã—ã¦ PAT ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª
          HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user)
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "PAT is valid"
            echo "valid=true" >> $GITHUB_OUTPUT
            
            # æˆåŠŸæ™‚ã®ã‚µãƒãƒªãƒ¼å‡ºåŠ›
            USERNAME=$(jq -r '.login' /tmp/response.json)
            echo "âœ… PAT æœ‰åŠ¹ (user: ${USERNAME})" >> $GITHUB_STEP_SUMMARY
          elif [ "$HTTP_STATUS" -eq 401 ]; then
            echo "PAT is invalid or expired"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "error_message=COPILOT_ASSIGN_PAT ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚(HTTP $HTTP_STATUS)" >> $GITHUB_OUTPUT
          else
            echo "Unexpected response: HTTP $HTTP_STATUS"
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "error_message=PAT ã®æ¤œè¨¼ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚(HTTP $HTTP_STATUS)" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for invalid PAT
        if: steps.existing_issue.outputs.exists != 'true' && steps.check.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ERROR_MESSAGE: ${{ steps.check.outputs.error_message }}
        run: |
          cat << EOF | gh issue create \
            --repo "${GITHUB_REPOSITORY}" \
            --title "ğŸ”‘ COPILOT_ASSIGN_PAT ã®æ›´æ–°ãŒå¿…è¦ã§ã™" \
            --body-file -
          ## æ¦‚è¦

          PAT (Personal Access Token) ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚

          ## ã‚¨ãƒ©ãƒ¼å†…å®¹

          ${ERROR_MESSAGE}

          ## å¯¾å¿œæ–¹æ³•

          1. GitHub ã® Settings > Developer settings > Personal access tokens ã‹ã‚‰æ–°ã—ã„ Fine-grained PAT ã‚’ä½œæˆã—ã¦ãã ã•ã„
          2. å¿…è¦ãªæ¨©é™:
             - \`Actions: Read and write\`
             - \`Contents: Read and write\`
             - \`Issues: Read and write\`
             - \`Pull requests: Read and write\`
          3. ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã‹ã‚‰ \`COPILOT_ASSIGN_PAT\` ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„

          ## é–¢é€£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

          - [issue-handler-add-model-to-copilot.yml](.github/workflows/issue-handler-add-model-to-copilot.yml)

          ---
          *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
          æ¤œå‡ºæ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
